0004 â€“ Phase 3 Architecture: The Constellation Slice


Date: 2025-12-04

Status: Done

1. Context


We have successfully implemented:

- **Phase 1 (The Focus Slice)**: Session timer and gamification via event bus.
- **Phase 2 (The Ritual Slice)**: Persistent storage and scripted ritual sequences.

Now we need to implement **Phase 3: The Constellation Slice**. The goal is to **link work to meaning** by allowing users to organize their focus sessions and rituals around larger projects or goals (Constellations).

Currently, users can complete focus sessions and rituals, earning rewards. However, these activities exist in isolationâ€”there's no way to answer:

- "What am I working toward?"
- "How much time have I invested in Project X?"
- "Which goals are getting neglected?"

**Constellations** solve this by introducing a lightweight project/goal system. A Constellation represents a meaningful area of life (e.g., "Launch SaaS", "Learn Piano", "Health & Fitness"). Users can:

1. Tag focus sessions with a Constellation via a "Project Picker".
2. Tag ritual completions with a Constellation (optional).
3. View time/session statistics per Constellation.

The challenge is to add this layer without cluttering the UI or violating our event-driven architecture.


---

2. Decision


We will implement this slice by introducing a **Constellation Module** that manages project definitions and session associations, and by extending the Session Timer to support project selection.

2.1 Modules

1. **@lemos/modules/constellation-os**: Manages Constellation definitions, session tagging, and aggregated statistics.

2. **Updates to @lemos/modules/session-timer**: Add optional `constellationId` field to session state. Emit `SessionStarted` and `SessionCompleted` events with constellation metadata.

2.2 State Management (Persistence Integration)

- **Constellation Definitions**: Stored in persistence (`constellation_definitions` table). Users can create, edit, archive Constellations.

- **Session Associations**: When a session completes, the `SessionCompleted` event includes `constellationId`. ConstellationModule listens and logs the association.

- **No UI-managed persistence**: React components call `ConstellationModule.createConstellation()` or `SessionTimerModule.startSession(constellationId)`. Modules handle persistence.

2.3 Constellation Definition Format

Constellations are defined as JSON manifests (initially hardcoded, later user-editable):

```json
{
  "id": "launch-saas",
  "name": "Launch SaaS",
  "description": "Build and ship my productivity app",
  "color": "#4A90E2",
  "icon": "rocket",
  "createdAt": "2025-12-01T00:00:00Z",
  "archived": false
}
```

Fields:
- `id`: Unique identifier (slug format).
- `name`: Display name.
- `description`: Optional user-facing description.
- `color`: Hex color for UI theming.
- `icon`: Icon identifier (future: emoji or icon library key).
- `archived`: If true, Constellation is hidden from pickers but stats remain.

2.4 Persistence Scope

For Phase 3, we persist:

- **Constellation Definitions**: `{ id, name, description, color, icon, createdAt, archived }`
- **Session Associations**: Foreign key in `session_logs` table: `constellationId` (nullable).
- **Ritual Associations**: Foreign key in `ritual_logs` table: `constellationId` (nullable).

We do NOT persist:

- Active session's constellation selection during runtime (handled by SessionTimer state).
- Aggregated statistics (computed on-demand by querying logs).

Rationale: Phase 3 focuses on tagging and basic reporting. Advanced analytics (streaks, forecasting) are deferred to Phase 4+.


---

3. Detailed Design

3.1 Storage Schema Extensions

We extend the existing schema with:

**A. constellation_definitions table**

```typescript
interface ConstellationDefinition {
  id: string;              // e.g., "launch-saas"
  name: string;            // "Launch SaaS"
  description: string;     // Optional
  color: string;           // Hex color
  icon: string;            // Icon key
  createdAt: string;       // ISO timestamp
  archived: boolean;       // Default false
}
```

**B. session_logs table (new)**

We introduce a new table to track completed focus sessions (previously not persisted):

```typescript
interface SessionLog {
  id: string;              // UUID
  sessionId: string;       // Generated by SessionTimer
  constellationId: string | null; // Foreign key
  startedAt: string;       // ISO timestamp
  completedAt: string;     // ISO timestamp
  durationSeconds: number; // Actual time worked
  plannedDuration: number; // Original timer setting
  wasCompleted: boolean;   // True if full duration, false if abandoned
}
```

**C. ritual_logs table (update)**

Add optional `constellationId` field to existing schema:

```typescript
interface RitualLog {
  id: string;
  ritualId: string;
  constellationId: string | null; // NEW
  completedAt: string;
  durationSeconds: number;
  stepsCompleted: string[];
}
```

3.2 Event Contract

We introduce new events and extend existing ones:

**A. Constellation Events**

- `ConstellationCreated: { id: string, name: string, color: string }`
- `ConstellationUpdated: { id: string, changes: Partial<ConstellationDefinition> }`
- `ConstellationArchived: { id: string }`

**B. Extended Session Events**

Update existing events from Phase 1:

- `SessionStarted: { sessionId: string, duration: number, constellationId?: string }`
- `SessionCompleted: { sessionId: string, durationSeconds: number, wasCompleted: boolean, constellationId?: string }`

**C. Extended Ritual Events**

Update existing events from Phase 2:

- `RitualCompleted: { ritualId: string, sessionId: string, totalDuration: number, completedAt: string, constellationId?: string }`

3.3 Data Flow

**1. Creating a Constellation:**

- User navigates to "Constellations" settings.
- UI calls `ConstellationModule.createConstellation({ name, color, ... })`.
- ConstellationModule generates ID, persists to storage.
- ConstellationModule emits `ConstellationCreated`.
- UI (listening) updates constellation picker options.

**2. Starting a Focus Session with a Constellation:**

- User selects "Launch SaaS" from Project Picker dropdown.
- User clicks "Start Focus" (25 min).
- UI calls `SessionTimerModule.startSession({ duration: 1500, constellationId: "launch-saas" })`.
- SessionTimerModule emits `SessionStarted` with `constellationId`.
- SessionTimerModule stores `constellationId` in internal state.
- UI renders timer with constellation badge: "ðŸš€ Launch SaaS".

**3. Completing a Focus Session:**

- Timer reaches 0.
- SessionTimerModule emits `SessionCompleted` with `constellationId: "launch-saas"`.
- ConstellationModule (listening) logs session: `storage.insert("session_logs", { constellationId: "launch-saas", ... })`.
- DopamineHeroModule (listening) awards energy/XP as usual.
- UI shows reward feedback with constellation context: "+10 Energy for Launch SaaS".

**4. Viewing Constellation Stats:**

- User opens "Constellations" page.
- UI calls `ConstellationModule.getStats("launch-saas")`.
- ConstellationModule queries:
  - `storage.query("session_logs", { constellationId: "launch-saas" })`
  - `storage.query("ritual_logs", { constellationId: "launch-saas" })`
- ConstellationModule computes:
  - Total sessions: 12
  - Total time: 5.5 hours
  - Last activity: 2 hours ago
- ConstellationModule returns aggregated stats.
- UI renders stats card.

3.4 Constellation Module API

```typescript
interface IConstellationModule {
  // CRUD operations
  createConstellation(def: Omit<ConstellationDefinition, "id" | "createdAt">): Promise<string>; // returns ID
  updateConstellation(id: string, changes: Partial<ConstellationDefinition>): Promise<void>;
  archiveConstellation(id: string): Promise<void>;

  // Queries
  listConstellations(includeArchived?: boolean): Promise<ConstellationDefinition[]>;
  getConstellation(id: string): Promise<ConstellationDefinition | null>;

  // Statistics
  getStats(id: string): Promise<ConstellationStats>;
}

interface ConstellationStats {
  constellationId: string;
  totalSessions: number;
  totalRituals: number;
  totalMinutes: number;
  lastActivityAt: string | null;
  completionRate: number; // % of sessions completed vs abandoned
}
```


---

4. Consequences

**Positive**

- **Meaning & Motivation**: Users can now answer "What am I working toward?" Sessions feel purposeful when tagged with a goal.
- **Progress Visibility**: Stats show which Constellations are active vs neglected, enabling better prioritization.
- **Flexible Tagging**: Constellation selection is optional. Users can still do "untagged" focus sessions for ad-hoc work.
- **Retroactive Analytics**: Session logs enable future features like weekly reports, streak tracking, and time forecasting.
- **UI Clarity**: Color-coded badges make it easy to see project context in session history.
- **Extensibility**: The Constellation concept can later expand to support sub-projects, goals, or OKRs.

**Negative**

- **Picker Overhead**: Adding a project picker to the Session Timer adds UI complexity. Risk of cluttering the minimal timer interface.
  - **Mitigation**: Make picker optional (collapsible dropdown). Default state: no constellation selected. Advanced users opt-in.

- **Database Growth**: Every session now creates a log entry. Long-term users could accumulate thousands of records.
  - **Mitigation**: Add data retention policy (e.g., archive sessions older than 1 year). Implement lazy-loading for stats queries.

- **Partial Associations**: Users may forget to tag sessions, leading to incomplete stats.
  - **Mitigation**: Show gentle reminder: "X untagged sessions this week. Tag them?" Phase 4 can add smart suggestions.

- **Constellation Proliferation**: Users may create too many Constellations, diluting focus.
  - **Mitigation**: Limit active Constellations to 5-7 (via UI warning, not hard block). Add "Archive" feature to hide completed projects.

- **No Hierarchy**: Constellations are flat. No support for sub-projects or categories.
  - **Mitigation**: Acceptable for Phase 3. Phase 4+ can add parent-child relationships if needed.


---

5. Implementation Plan

**1. Define Constellation Schema:**
   - Add `ConstellationDefinition` interface to `@lemos/core/src/types.ts`.
   - Extend `SessionLog` and `RitualLog` types with `constellationId` field.

**2. Implement Storage Migrations:**
   - Update `@lemos/platform-storage-local` to create `constellation_definitions` table.
   - Create `session_logs` table.
   - Add `constellationId` column to `ritual_logs` table.
   - Add versioning: `schema_version = 2`.

**3. Create ConstellationModule:**
   - Implement `@lemos/modules/constellation-os`.
   - Add CRUD methods: `createConstellation`, `updateConstellation`, `archiveConstellation`.
   - Add query methods: `listConstellations`, `getConstellation`.
   - Add stats aggregation: `getStats`.
   - Emit `ConstellationCreated`, `ConstellationUpdated`, `ConstellationArchived` events.

**4. Update SessionTimerModule:**
   - Add `constellationId?: string` parameter to `startSession()`.
   - Store `constellationId` in session state.
   - Include `constellationId` in `SessionStarted` and `SessionCompleted` events.
   - On `SessionCompleted`, log session to storage via `ConstellationModule`.

**5. Update RitualModule:**
   - Add `constellationId?: string` parameter to `startRitual()`.
   - Include `constellationId` in `RitualCompleted` event.
   - Update storage.insert call to include `constellationId`.

**6. Seed Initial Constellations:**
   - Create `constellation-os/constellations/defaults.json` with 3 example Constellations:
     - "Work" (color: blue, icon: briefcase)
     - "Personal Growth" (color: green, icon: seedling)
     - "Health" (color: red, icon: heart)
   - Load and persist on first boot (if no Constellations exist).

**7. Build UI Components:**
   - Create `<ConstellationPicker />`:
     - Dropdown component with constellation options.
     - Shows color badge + name.
     - "No Project" option (null value).
     - Integrates into Session Timer start form.
   - Create `<ConstellationBadge />`:
     - Displays constellation color + name inline.
     - Used in session history, timer active state.
   - Create `<ConstellationList />`:
     - Settings page: List all Constellations.
     - Edit/Archive buttons.
   - Create `<ConstellationStats />`:
     - Card showing total sessions, hours, last activity.
     - Progress bar visualization.

**8. Integration Testing:**
   - Test constellation creation and persistence.
   - Test session tagging: Start session with constellation, verify log entry.
   - Test stats calculation: Complete 3 sessions, verify counts.
   - Test archiving: Archive constellation, verify it's hidden from picker but stats remain.
   - Test optional tagging: Complete session without constellation, verify no association.

**9. Documentation:**
   - Update README with Constellation concept explanation.
   - Document ConstellationModule API.
   - Add screenshots of Project Picker in session flow.


---

6. Open Questions

1. **Constellation Limit**: Should we enforce a max number of active Constellations?
   - **Proposal**: Soft limit of 7 active (UI warning, not blocked). Encourage archiving completed projects.

2. **Retroactive Tagging**: Should users be able to tag past sessions with a Constellation?
   - **Proposal**: Defer to Phase 4. Phase 3 only supports tagging at session start.

3. **Smart Suggestions**: Should the app suggest a Constellation based on time-of-day or recent history?
   - **Proposal**: Phase 4 feature. Phase 3 keeps picker manual.

4. **Constellation Templates**: Should we offer preset Constellations (e.g., "Side Project", "Fitness", "Learning")?
   - **Proposal**: Yes. Seed 3 defaults on first boot (see Implementation Plan #6). Users can customize or delete.

5. **Multi-Constellation Sessions**: Should a session be taggable with multiple Constellations?
   - **Proposal**: No. Keep it simple: 1 session = 0 or 1 Constellation. If needed, users can split sessions.

6. **Constellation Rewards**: Should completing X sessions in a Constellation unlock bonus energy/XP?
   - **Proposal**: Phase 4 feature. Phase 3 keeps rewards global (per DopamineHeroModule).

7. **Constellation Privacy**: If we add multi-user support later, should Constellations be private?
   - **Proposal**: Defer to Phase 5. For now, assume single-user.


---

**Dependencies:**
- Requires Phase 2 (Ritual Slice) persistence layer.
- Extends Phase 1 (Focus Slice) Session Timer.

**Unlocks:**
- Phase 4: Analytics & Insights (weekly reports, constellation streaks).
- Phase 5: Social features (share constellation progress).
