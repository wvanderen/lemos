# Constellation OS Design

## Overview

The Constellation OS module implements **Phase 3: The Constellation Slice** as described in [ADR 0004](../../../docs/adr/0004-constellation-slice.md). It provides a lightweight project/goal system that links focus sessions and rituals to meaningful objectives.

## Domain Model

### Core Entities

**ConstellationDefinition**
```typescript
interface ConstellationDefinition {
  id: string;              // Slug-style identifier (e.g., "launch-saas")
  name: string;            // Display name
  description: string;     // User-facing description
  color: string;           // Hex color for UI theming
  icon: string;            // Icon identifier (emoji or icon library key)
  createdAt: string;       // ISO timestamp
  archived: boolean;       // If true, hidden from pickers but stats remain
}
```

**SessionLog**
```typescript
interface SessionLog {
  id: string;              // UUID
  sessionId: string;       // Generated by SessionTimer
  constellationId: string | null; // Foreign key to constellation
  startedAt: string;       // ISO timestamp
  completedAt: string;     // ISO timestamp
  durationSeconds: number; // Actual time worked
  plannedDuration: number; // Original timer setting
  wasCompleted: boolean;   // True if full duration, false if abandoned
}
```

**ConstellationStats** (Computed)
```typescript
interface ConstellationStats {
  constellationId: string;
  totalSessions: number;
  totalRituals: number;
  totalMinutes: number;
  lastActivityAt: string | null;
  completionRate: number; // % of sessions completed vs abandoned
}
```

## Data Flow

### 1. Creating a Constellation

```
User → UI (ConstellationList)
  ↓
constellationOS.createConstellation()
  ↓
storage.insert('constellation_definitions', {...})
  ↓
EventBus.emit('ConstellationCreated')
  ↓
UI updates constellation picker options
```

### 2. Starting a Focus Session with Constellation

```
User selects constellation from picker
  ↓
UI calls timer.startSession(duration, constellationId)
  ↓
SessionTimer stores constellationId internally
  ↓
EventBus.emit('SessionStarted', { ..., constellationId })
  ↓
UI renders timer with constellation badge
```

### 3. Completing a Focus Session

```
Timer reaches 0
  ↓
SessionTimer.endSession()
  ↓
EventBus.emit('SessionEnded', { ..., constellationId })
  ↓
ConstellationOS listens → logSession()
  ↓
storage.insert('session_logs', {...})
  ↓
DopamineHero listens → awards energy/XP
```

### 4. Viewing Statistics

```
UI calls constellationOS.getStats(id)
  ↓
Query session_logs WHERE constellationId = id
  ↓
Query ritual_logs WHERE constellationId = id
  ↓
Aggregate: total sessions, time, completion rate
  ↓
Return ConstellationStats
```

## Event-Driven Architecture

### Events Emitted

| Event | Payload | Trigger |
|-------|---------|---------|
| `ConstellationCreated` | `{ id, name, color, icon }` | When `createConstellation()` succeeds |
| `ConstellationUpdated` | `{ id, changes }` | When `updateConstellation()` succeeds |
| `ConstellationArchived` | `{ id }` | When `archiveConstellation()` succeeds |

### Events Consumed

| Event | Handler | Purpose |
|-------|---------|---------|
| `SessionEnded` | `logSession()` | Insert session log with constellation association |
| `RitualCompleted` | `updateRitualLog()` | Track ritual completion (handled by RitualOS) |

## Storage Schema

### constellation_definitions

| Field | Type | Description |
|-------|------|-------------|
| id | string (PK) | Slug identifier |
| name | string | Display name |
| description | string | User description |
| color | string | Hex color code |
| icon | string | Emoji or icon key |
| createdAt | string | ISO timestamp |
| archived | boolean | Archive status |

### session_logs (new in Phase 3)

| Field | Type | Description |
|-------|------|-------------|
| id | string (PK) | UUID |
| sessionId | string | From SessionTimer |
| constellationId | string (FK, nullable) | Optional association |
| startedAt | string | ISO timestamp |
| completedAt | string | ISO timestamp |
| durationSeconds | number | Actual time |
| plannedDuration | number | Original setting |
| wasCompleted | boolean | Completion status |

### ritual_logs (extended)

Added field: `constellationId: string | null`

## Implementation Patterns

### Optional Tagging

Constellation selection is **always optional**. Users can:

- Start untagged sessions for ad-hoc work
- Tag sessions at the start (no retroactive tagging in Phase 3)
- Choose "No Project" from picker to explicitly skip tagging

### ID Generation

Constellation IDs are **slug-style**:
- Derived from name: `"Launch SaaS"` → `"launch-saas"`
- Lowercase, hyphenated, alphanumeric only
- Ensures human-readable URLs and consistent references

### Statistics Computation

Stats are **computed on-demand** (not cached):
- Query session_logs and ritual_logs on each `getStats()` call
- Aggregate in-memory (acceptable for Phase 3 scale)
- Future optimization: incremental updates or cached aggregates

### Default Seeding

On first initialization:
1. Check if `constellation_definitions` table is empty
2. If empty, load `constellations/defaults.json`
3. Insert 3 default constellations with predefined IDs
4. Log success, set `initialized = true`

Subsequent initializations skip seeding (idempotent).

## Module Lifecycle

```typescript
class ConstellationOS {
  constructor(bus, storage) {
    this.setupListeners()  // Subscribe to events
    this.initializeDefaults() // Seed if needed
  }
}
```

1. **Constructor**: Receives EventBus and IStorage
2. **setupListeners()**: Subscribe to SessionEnded, RitualCompleted
3. **initializeDefaults()**: Check for existing data, seed if empty
4. **Public API**: CRUD operations, queries, stats

## Error Handling

- **Storage unavailable**: Methods return empty arrays or throw descriptive errors
- **Constellation not found**: `getConstellation()` returns `null`
- **Invalid operations**: `createConstellation()` with duplicate ID fails gracefully

## Future Enhancements (Phase 4+)

- **Retroactive Tagging**: Tag past sessions from history view
- **Smart Suggestions**: Auto-suggest constellation based on time-of-day or recent history
- **Constellation Rewards**: Bonus XP for completing X sessions in a constellation
- **Hierarchy**: Parent-child relationships for sub-projects
- **Multi-Constellation Sessions**: Tag sessions with multiple constellations
- **Forecasting**: Predict completion dates based on current velocity

## Testing Strategy

- Unit tests for CRUD operations
- Event emission verification
- Stats calculation accuracy
- Edge cases: empty logs, archived constellations, null associations
- Integration test: full session flow with constellation
